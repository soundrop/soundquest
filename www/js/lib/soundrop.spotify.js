(function(){var e,t,n;(function(r){function p(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)==="."&&t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function d(e,t){return function(){return s.apply(r,h.call(arguments,0).concat([e,t]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){a[e]=t}}function g(e){if(f.hasOwnProperty(e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!a.hasOwnProperty(e)&&!c.hasOwnProperty(e))throw new Error("No "+e);return a[e]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=[].slice;o=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return d(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:b(e)}}},i=function(e,t,n,i){var s,l,h,p,v,y=[],b;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")y[v]=u.require(e);else if(l==="exports")y[v]=u.exports(e),b=!0;else if(l==="module")s=y[v]=u.module(e);else if(a.hasOwnProperty(l)||f.hasOwnProperty(l)||c.hasOwnProperty(l))y[v]=g(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,d(i,!0),m(l),{}),y[v]=a[l]}}h=n.apply(a[e],y);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!b)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):g(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},15),s)},s.config=function(e){return l=e,s},n=function(e,t,n){t.splice||(n=t,t=[]),f[e]=[e,t,n]},n.amd={jQuery:!0}})(),n("almond",[],function(){}),n("lib/tracks",["soundrop/main"],function(e){var t,n,r;return t={},r=getSpotifyApi(),n=r.require("$api/models"),t.Tracks=function(){function t(){}return t.lookup=function(t){var r;return r=new e.deferred.Deferred,n.Track.fromURI(t,function(e){return r.resolve(e)}),r.promise()},t.findPlayable=function(t){var r,i,s,o;return s=new e.deferred.Deferred,r=function(){var e,n,r;r=[];for(e=0,n=t.length;e<n;e++)o=t[e],o.indexOf("spotify:track:")===0&&r.push(o);return r}(),r.length>0?(i=function(e){return n.Track.fromURI(e,function(e){return e.data.availableForPlayback?s.resolve(e):r.length>0?i(r.shift()):s.reject("not-found")})},i(r.shift())):s.reject("not-found"),s.promise()},t}(),t}),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,r=Array.prototype.indexOf||function(e){for(var n=0,r=this.length;n<r;n++)if(t.call(this,n)&&this[n]===e)return n;return-1};n("lib/playback",["soundrop/main","./tracks"],function(t,n){var i,s,o;return i={},o=getSpotifyApi(),s=o.require("$api/models"),i.Playback=function(){function u(){this._onPlayerEvent=e(this._onPlayerEvent,this),this._state="paused",this._seekTimer=null,this._events=0,this._lastWindow=null,this._contexts=[],this._player=s.player,this._player.observe(s.EVENT.CHANGE,this._onPlayerEvent),this._playlist=new s.Playlist,o.trackPlayer.setContextCanSkipPrev(this._playlist.uri,!1),o.trackPlayer.setContextCanSkipNext(this._playlist.uri,!1),o.trackPlayer.setContextCanShuffle(this._playlist.uri,!1),o.trackPlayer.setContextCanRepeat(this._playlist.uri,!1)}var i;return u.prototype.dispose=function(){return this._player.ignore(s.EVENT.CHANGE,this._onPlayerEvent)},u.prototype.play=function(){return this._process({name:"playback:play"})},u.prototype.stop=function(){return this._process({name:"playback:stop"})},u.prototype.isPlaying=function(){return this._state!=="stopped"},u.prototype.pushContext=function(e,n){var r;return n==null&&(n={}),r=new i(this,e,t.utils.extend({},{syncOffset:!0,repeat:!0},n)),this._contexts.unshift(r),r},u.prototype.deleteContext=function(e){var t,n,r,i;i=this._contexts;for(n=0,r=i.length;n<r;n++){t=i[n];if(t===e){this._contexts.splice(n,1);break}}if((t=this._contexts[0])!=null)return this._process({name:"context:sync",data:t});if(this._state!=="stopped")return this._state="paused",this._player.playing=!1,this._clearPlaylist()},u.prototype._onPlayerEvent=function(e){return this._process({name:"player:event",data:e.data})},u.prototype._process=function(e){var t,n,i,s,u,a,f,l,c,h,p,d=this;if(this._contexts.length===0||e.name==="context:sync"&&e.data!==this._contexts[0])return;t=this._contexts[0],this._events++,i=new Date;if(this._lastWindow==null||i.getTime()-this._lastWindow.getTime()>=1e3)this._events>50?(this._state="stopped",t.callbacks.onStopped(t),this._player.playing=!1):this._events=0,this._lastWindow=i;switch(this._state){case"stopped":if(e.name==="playback:play")return((l=this._player.track)!=null?l.data.isAd:void 0)?(this._state="paused",t.callbacks.onPaused("advertisement",t),this._player.playing=!0):(this._state="synching",this._sync(t));if(e.name==="player:event"&&this._player.context===this._playlist.uri&&this._player.playing)return this._state="synching",this._sync(t);break;case"paused":if(e.name==="playback:stop")return this._state="stopped",t.callbacks.onStopped(t),this._player.playing=!1;if(e.name==="context:sync")return((c=this._player.track)!=null?c.data.isAd:void 0)?(t.callbacks.onPaused("advertisement",t),this._player.playing=!0):(this._state="synching",this._sync(t));if(e.name==="player:event")if((h=this._player.track)!=null?h.data.isAd:void 0){if(this._player.playing)return t.callbacks.onPaused("advertisement",t);if(e.data.playstate)return this._state="stopped",t.callbacks.onStopped(t)}else if(e.data.curtrack)return this._state="synching",this._sync(t);break;case"synching":if(e.name==="context:sync")return this._sync(e.data);break;case"start-playing":if(e.name==="context:sync")return this._state="synching",this._sync(e.data);if(e.name==="player:event"&&((p=this._player.track)!=null?p.data.isAd:void 0))return this._state="paused",t.callbacks.onPaused("advertisement",t),this._player.playing=!0;break;case"seeking":if(e.name==="playback:stop")return clearInterval(this._seekTimer),this._seekTimer=null,this._state="stopped",t.callbacks.onStopped(t),this._player.playing=!1;if(e.name==="context:sync")return clearInterval(this._seekTimer),this._seekTimer=null,this._state="synching",this._sync(e.data);if(e.name==="player:event"&&(e.data.curtrack||e.data.playstate))return clearInterval(this._seekTimer),this._seekTimer=null,this._state="playing",this._process(e);if(e.name==="player:event"||e.name==="playback:seek")if(this._seekTimer==null)return u=0,n=null,s=function(){var e,i,s,a,f,l,c,h,p,v,m;c=d._player.track;if(d._state!=="seeking"||t!==d._contexts[0]||c==null||u++===200){clearInterval(d._seekTimer),d._seekTimer=null,d._state==="seeking"&&(d._contexts.length>0?d._state="playing":(d._state="stopped",d._player.playing=!1));return}a=d._player.position;if(n!=null){if(a!==n)return l=(v=c.uri,r.call(t.items[0].uris,v)>=0),p=(new Date).getTime()-t.started.getTime(),h=t.items[0].length,s=(i=(m=o.trackPlayer.getNowPlayingTrack())!=null?m.length:void 0)?i:h,e=p>=h-1e3&&p-h<=1e3?a:p%s,f=Math.abs(a-e)<700,l&&s&&!f?(n=null,d._player.position=e):(clearInterval(d._seekTimer),d._seekTimer=null,d._state="playing")}else if(a!==0)return n=a},this._seekTimer=setInterval(s,50),s();break;case"playing":if(e.name==="playback:stop")return this._player.playing=!1;if(e.name==="context:sync")return this._state="synching",this._sync(e.data);if(e.name==="player:event"){a=this._player.context;if(a===null){f=this._player.track;if(this._player.playing)return f.data.isAd?(this._state="paused",t.callbacks.onPaused("advertisement",t)):(this._state="stopped",t.callbacks.onStopped(t));if(f===null&&this._playlist.length>0)return t.options.repeat?(this._state="synching",this._sync(t)):(this._state="paused",t.callbacks.onPaused("end",t))}else{if(a!==this._playlist.uri)return this._state="stopped",t.callbacks.onStopped(t);if(!this._player.playing)return this._state="stopped",t.callbacks.onStopped(t);if(t.options.syncOffset)return this._state="seeking",this._process({name:"playback:seek"})}}}},u.prototype._sync=function(e){var t,r,i,s,u,a,f=this;return r=e.revision,t=e.items,u=[],a=t.length,i=function(){return e===f._contexts[0]&&r===e.revision},s=function(e,t){var n,r;return t?(n=Math.floor(t/1e3/60),r=t/1e3%60,""+e+"#"+n+":"+r.toFixed(2)):e},t.length>0?t.forEach(function(r,l){var c;return u.push(null),c=n.Tracks.findPlayable(r.uris),c.done(function(e){return u[l]=e}),c.always(function(){var n,r,l,c,h,p,d,v,m,g,y,b,w,E,S;if(--a===0&&f._state==="synching"&&i()){if((r=u[0])==null)return f._clearPlaylist(),f._state="paused",f._player.playing&&(f._player.playing=!1),e.callbacks.onPaused("not-available",e);c=f._playlist.indexOf(r.uri);if(c!==-1){while(c>0&&f._player.context===f._playlist.uri&&f._player.index>0)f._playlist.remove(0),c--;while(f._playlist.length>c+1)f._playlist.remove(c+1);S=u.slice(1);for(y=0,w=S.length;y<w;y++)g=S[y],g!=null&&f._playlist.add(g.uri)}else{c=0,f._clearPlaylist();for(b=0,E=u.length;b<E;b++)g=u[b],g!=null&&f._playlist.add(g.uri)}m=(new Date).getTime()-e.started.getTime(),v=t[0].length,p=f._player.position,h=r.data.duration,f._player.context===f._playlist.uri&&f._player.index===c?n="soft":f._player.context===f._playlist.uri&&f._player.index>=0&&f._player.index===c-1?(d=o.trackPlayer.getNowPlayingTrack())!=null&&d.position&&d.length?(l=d.length-d.position+m,n=l<1400?"none":"hard"):n="hard":f._player.context===f._playlist.uri&&f._player.index>=0&&f._player.index===c+1?(l=v-m+p,n=l<1400?"none":"hard"):n="hard";switch(n){case"hard":return f._state="start-playing",o.trackPlayer.playTrackFromContext(f._playlist.uri,c,s(r.uri,m%h),{onSuccess:function(){var t;if(f._state==="start-playing"&&i())return e.callbacks.onPlaying(r,e),f._state="seeking",t=function(){return f._process({name:"playback:seek"})},window.setTimeout(t,0)},onFailure:function(){if(f._state==="start-playing"&&i())return f._state="stopped",e.callbacks.onStopped(e)}});case"soft":return f._state="seeking",e.callbacks.onPlaying(r,e),f._player.playing=!0,f._process({name:"playback:seek"});case"none":return f._state="playing"}}})}):(this._state="paused",this._player.playing&&(this._player.playing=!1),e.callbacks.onPaused("end",e))},u.prototype._clearPlaylist=function(){var e;e=[];while(this._playlist.length>0)e.push(this._playlist.remove(0));return e},i=function(){function e(e,t,n){this.playback=e,this.name=t,this.options=n,this.callbacks={},this.items=[],this.started=null,this.revision=0}return e.prototype.sync=function(e,t){e=e.slice(0,2);if(JSON.stringify(e)===JSON.stringify(this.items)&&t===this.started)return;return this.items=e,this.started=t,this.revision++,this.playback._process({name:"context:sync",data:this})},e}(),u}(),i})}.call(this),n("main",["./lib/tracks","./lib/playback"],function(e,t){return{Tracks:e.Tracks,Playback:t.Playback}}),n("main.standalone",["./main"],function(e){return window.soundrop.spotify=e,e}),n("soundrop/main",[],function(){return window.soundrop}),t(["main.standalone"],function(){},"main.init",!0)})();