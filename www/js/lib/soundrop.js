(function(){var e,t,n;(function(r){function p(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)==="."&&t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function d(e,t){return function(){return s.apply(r,h.call(arguments,0).concat([e,t]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){a[e]=t}}function g(e){if(f.hasOwnProperty(e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!a.hasOwnProperty(e)&&!c.hasOwnProperty(e))throw new Error("No "+e);return a[e]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=[].slice;o=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return d(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:b(e)}}},i=function(e,t,n,i){var s,l,h,p,v,y=[],b;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")y[v]=u.require(e);else if(l==="exports")y[v]=u.exports(e),b=!0;else if(l==="module")s=y[v]=u.module(e);else if(a.hasOwnProperty(l)||f.hasOwnProperty(l)||c.hasOwnProperty(l))y[v]=g(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,d(i,!0),m(l),{}),y[v]=a[l]}}h=n.apply(a[e],y);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!b)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):g(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},15),s)},s.config=function(e){return l=e,s},n=function(e,t,n){t.splice||(n=t,t=[]),f[e]=[e,t,n]},n.amd={jQuery:!0}})(),n("almond",[],function(){}),function(){var e=Array.prototype.slice;n("lib/events",[],function(){var t;return t={},t.Events=function(){function t(){this.initialize.apply(this,arguments)}return t.prototype.initialize=function(){},t.prototype.on=function(e,t){var n;return n=this.hasOwnProperty("_callbacks")&&this._callbacks||(this._callbacks={}),n[e]||(n[e]=[]),n[e].push(t),t},t.prototype.off=function(e,t){var n,r,i,s,o;n=(o=this._callbacks)!=null?o[e]:void 0;if(!n)return this;if(!t)return delete this._callbacks[e],this;for(i=0,s=n.length;i<s;i++){r=n[i];if(r!==t)continue;n=n.slice(),n.splice(i,1),this._callbacks[e]=n;break}return t},t.prototype._trigger=function(){var t,n,r,i,s,o,u;i=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],r=this.hasOwnProperty("_callbacks")&&((u=this._callbacks)!=null?u[i]:void 0);if(!r)return!1;for(s=0,o=r.length;s<o;s++)n=r[s],n.apply(this,t);return!0},t}(),t})}.call(this),function(){var e=Array.prototype.slice;n("lib/deferred",[],function(){var t;return t={},t.Deferred=function(){function n(){this._state="pending",this._promise=new t}var t;return n.prototype.state=function(){return this._state},n.prototype.promise=function(){return this._promise},n.prototype.always=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this._promise.always.apply(this._promise,arguments),this},n.prototype.done=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this._promise.done.apply(this._promise,arguments),this},n.prototype.fail=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this._promise.fail.apply(this._promise,arguments),this},n.prototype.progress=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this._promise.progress.apply(this._promise,arguments),this},n.prototype.then=function(e,t){return this._promise.then.apply(this._promise,arguments),this},n.prototype.pipe=function(e,t){return this._promise.pipe.apply(this._promise,arguments)},n.prototype.resolve=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.resolveWith.apply(this,[this].concat(e.call(t)))},n.prototype.resolveWith=function(){var t,n;n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[];if(this._state!=="pending")throw"bad-state";return this._state="resolved",this._promise._resolveWith.apply(this._promise,arguments),this},n.prototype.reject=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.rejectWith.apply(this,[this].concat(e.call(t)))},n.prototype.rejectWith=function(){var t,n;n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[];if(this._state!=="pending")throw"bad-state";return this._state="rejected",this._promise._rejectWith.apply(this._promise,arguments),this},n.prototype.notify=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this},n.prototype.notifyWith=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this},t=function(){function t(){this._context=null,this._result=null,this._error=null,this._alwaysCallbacks=[],this._doneCallbacks=[],this._failCallbacks=[]}return t.prototype.promise=function(){return this},t.prototype.always=function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[];for(i=0,o=t.length;i<o;i++){n=t[i];if(n instanceof Array)for(s=0,u=n.length;s<u;s++)r=n[s],this.always(r);else this._result!=null?n.apply(this._context,this._result):this._error!=null?n.apply(this._context,this._error):this._alwaysCallbacks.push(n)}return this},t.prototype.done=function(){var t,n,r,i,s,o,u;r=1<=arguments.length?e.call(arguments,0):[];for(i=0,o=r.length;i<o;i++){t=r[i];if(t instanceof Array)for(s=0,u=t.length;s<u;s++)n=t[s],this.done(n);else this._result!=null?t.apply(this._context,this._result):this._error==null&&this._doneCallbacks.push(t)}return this},t.prototype.fail=function(){var t,n,r,i,s,o,u;r=1<=arguments.length?e.call(arguments,0):[];for(i=0,o=r.length;i<o;i++){t=r[i];if(t instanceof Array)for(s=0,u=t.length;s<u;s++)n=t[s],this.fail(n);else this._error!=null?t.apply(this._context,this._error):this._result==null&&this._failCallbacks.push(t)}return this},t.prototype.progress=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this},t.prototype.then=function(e,t){return e!=null&&this.done(e),t!=null&&this.fail(t),this},t.prototype.pipe=function(e,n){var r,i,s;return r=new t,s=function(e,t){var n;return n=[e],n.push.apply(n,t),r._resolveWith.apply(r,n)},i=function(e,t){var n;return n=[e],n.push.apply(n,t),r._rejectWith.apply(r,n)},this.done(function(){var t,n;if(e!=null){n=e.apply(this,arguments);if(typeof (n!=null?n.done:void 0)=="function"){n.done(function(){return s(this,arguments)}),n.fail(function(){return i(this,arguments)});return}t=n!=null?[n]:[]}else t=arguments;return s(this,t)}),this.fail(function(){var e,t;if(n!=null){t=n.apply(this,arguments);if(typeof (t!=null?t.done:void 0)=="function"){t.done(function(){return s(this,arguments)}),t.fail(function(){return i(this,arguments)});return}e=t!=null?[t]:[]}else e=arguments;return i(this,e)}),r},t.prototype._resolveWith=function(){var t,n,r,i,s,o,u,a,f;r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this._context=r,this._result=t,a=this._doneCallbacks.splice(0,this._doneCallbacks.length);for(i=0,o=a.length;i<o;i++)n=a[i],n.apply(r,t);f=this._alwaysCallbacks.splice(0,this._alwaysCallbacks.length);for(s=0,u=f.length;s<u;s++)n=f[s],n.apply(r,t);return this},t.prototype._rejectWith=function(){var t,n,r,i,s,o,u,a,f;r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this._context=r,this._error=t,a=this._failCallbacks.splice(0,this._failCallbacks.length);for(i=0,o=a.length;i<o;i++)n=a[i],n.apply(r,t);f=this._alwaysCallbacks.splice(0,this._alwaysCallbacks.length);for(s=0,u=f.length;s<u;s++)n=f[s],n.apply(r,t);return this},t}(),n}(),t})}.call(this),function(){var e=Array.prototype.slice,t=Object.prototype.hasOwnProperty;n("lib/utils",[],function(){var n;return n={},n.extend=function(){var n,r,i,s,o,u,a;s=arguments[0],i=2<=arguments.length?e.call(arguments,1):[];for(u=0,a=i.length;u<a;u++){r=i[u];for(n in r){if(!t.call(r,n))continue;o=r[n],o!==void 0&&(s[n]=JSON.parse(JSON.stringify(o)))}}return s},n.update=function(e,r){var i,s;for(i in r){if(!t.call(r,i))continue;s=r[i],s===null?delete e[i]:typeof s!="object"||s instanceof Array?e[i]=s:e[i]==null?e[i]=s:n.update(e[i],s)}return},n})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,r=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};n("lib/wocket",["./events","./utils"],function(t,n){var i,s,o,u,a;return a={},s={},typeof module!="undefined"?(u=module.require("websocket").client,o=function(){function t(t){this._onMessage=e(this._onMessage,this),this._onError=e(this._onError,this),this._onClose=e(this._onClose,this),this._onConnectFailed=e(this._onConnectFailed,this),this._onConnect=e(this._onConnect,this);var n=this;this.onopen=null,this.onclose=null,this.onmessage=null,this.onerror=null,this._client=new u,this._client.addListener("connect",this._onConnect),this._client.addListener("connectFailed",this._onConnectFailed),this._connection=null,process.nextTick(function(){var e;return(e=n._client)!=null?e.connect(t):void 0})}return t.prototype.close=function(){return this._client!=null&&(this._client.removeListener("connect",this._onConnect),this._client.removeListener("connectFailed",this._onConnectFailed),this._client=null),this._connection!=null&&(this._connection.removeListener("close",this._onClose),this._connection.removeListener("error",this._onError),this._connection.removeListener("message",this._onMessage),this._connection.close(),this._connection=null),this.onclose()},t.prototype.send=function(e){return this._connection.sendUTF(e)},t.prototype._onConnect=function(e){return this._client!=null?(this._connection=e,this._connection.addListener("close",this._onClose),this._connection.addListener("error",this._onError),this._connection.addListener("message",this._onMessage),this.onopen()):e.close()},t.prototype._onConnectFailed=function(e){return this.onerror(e),this.onclose()},t.prototype._onClose=function(){return this.onclose()},t.prototype._onError=function(e){return this.onerror(e)},t.prototype._onMessage=function(e){if(e.type==="utf8")return this.onmessage({data:e.utf8Data})},t}()):o=window.WebSocket||window.MozWebSocket,i=function(){function s(){this._onError=e(this._onError,this),this._onMessage=e(this._onMessage,this),this._onClose=e(this._onClose,this),this._onOpen=e(this._onOpen,this),this.ping=e(this.ping,this),s.__super__.constructor.apply(this,arguments)}var n,i;return r(s,t.Events),n=1e4,i=9e4,s.prototype.initialize=function(e,t){return this.host=e,this.params=t,this._state="closed",this._socket=null,this._timeout=null},s.prototype.open=function(){return this._state="opening",this._timeout=setTimeout(this._onClose,n)},s.prototype.send=function(e){return clearTimeout(this._timeout),this._timeout=setTimeout(this.ping,i),this._socket.send(JSON.stringify(e))},s.prototype.close=function(){var e;try{return(e=this._socket)!=null?e.close():void 0}catch(t){}},s.prototype.ping=function(){return clearTimeout(this._timeout),this._timeout=setTimeout(this.ping,i),this._socket.send("")},s.prototype._onOpen=function(){return this._state="waiting_for_init",this.send({_id:"websocket-0",name:".init"})},s.prototype._onClose=function(){return this._state="closed",clearTimeout(this._timeout),this._timeout=null,this._trigger("close")},s.prototype._onMessage=function(e){var t;t=JSON.parse(e.data);switch(this._state){case"waiting_for_init":return t.name==="+result"?(this._state="waiting_for_session",this.send({_id:"websocket-1",name:".create-session",payload:this.params})):t.name==="+error"?this._trigger("error",t.payload):(this._trigger("error",{type:"cancel",reason:"protocol-error"}),this._socket.close());case"waiting_for_session":return t.name==="+result"?(this._state="open",clearTimeout(this._timeout),this._timeout=setTimeout(this.ping,i),this._trigger("open")):t.name==="+error"?this._trigger("error",t.payload):(this._trigger("error",{type:"cancel",reason:"protocol-error"}),this._socket.close());case"open":return clearTimeout(this._timeout),this._timeout=setTimeout(this.ping,i),this._trigger("stanza",t)}},s.prototype._onError=function(e){return e==null&&(e={}),this._trigger("error",{type:"cancel",reason:"transport-error",code:e.code,message:e.message})},s}(),s.WebSocket=function(){function e(){e.__super__.constructor.apply(this,arguments)}return r(e,i),e.prototype.open=function(){return e.__super__.open.call(this),this._socket=new o(this._url(this.host)),this._socket.onopen=this._onOpen,this._socket.onclose=this._onClose,this._socket.onmessage=this._onMessage,this._socket.onerror=this._onError},e.prototype._url=function(e){return"ws://"+e+"/websocket"},e}(),s.SecureWebSocket=function(){function e(){e.__super__.constructor.apply(this,arguments)}return r(e,s.WebSocket),e.prototype._url=function(e){return"wss://"+e+"/websocket"},e}(),s.FlashSocket=function(){function t(){this._onLoad=e(this._onLoad,this),t.__super__.constructor.apply(this,arguments)}return r(t,i),t.prototype.open=function(){var e,n,r,i,s,o,u,a,f,l,c=this;if(typeof window=="undefined")throw"Transport not supported";if(typeof document=="undefined")throw"Transport not supported";if(typeof navigator=="undefined")throw"Transport not supported";try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),o=!0}catch(h){if((f=navigator.mimeTypes["application/x-shockwave-flash"])!=null?!f.enabledPlugin:!void 0)throw"Transport not supported";o=!1}t.__super__.open.call(this),e=function(e,t,n){var r;return r=document.createElement("param"),r.setAttribute("name",t),r.setAttribute("value",n),e.appendChild(r)};try{this._id="wocketTransportFlashSocket"+(new Date).getTime(),window[this._id]=this,u=""+this._url(this.host)+"/client/flashsocket.swf",l=this.host.split(":"),r=l[0],i=l[1],i===void 0?i=843:i=parseInt(i,10)+843,s="host="+encodeURIComponent(r)+"&port="+encodeURIComponent(i)+"&instance="+encodeURIComponent(this._id),o?(n=document.createElement("div"),n.innerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000">'+('<param name="movie" value="'+u+'">')+('<param name="flashvars" value="'+s+'">')+'<param name="allowScriptAccess" value="always">'+'<param name="hasPriority" value="true">'+"</object>",a=n.firstChild):(n=a=document.createElement("object"),a.setAttribute("type","application/x-shockwave-flash"),a.setAttribute("data",u),e(a,"movie",u),e(a,"flashvars",s),e(a,"allowScriptAccess","always"),e(a,"hasPriority","true")),a.setAttribute("id",this._id),a.setAttribute("width","1"),a.setAttribute("height","1")}catch(p){throw delete window[this._id],p}return this._socket=a,n.setAttribute("style","position: fixed; top: 0; left: 0; opacity: 0.001; pointer-events: none; z-index: -9999;"),document.body.appendChild(n),this.on("close",function(){return delete window[c._id],document.body.removeChild(n)})},t.prototype._onLoad=function(){if(this._state==="opening")try{return this._socket.open()}catch(e){return this._trigger("error",{type:"cancel",reason:"transport-error",message:e.message}),this._state="closed",this._trigger("close")}},t.prototype._url=function(e){var t,n;return t=(typeof window!="undefined"&&window!==null?(n=window.location)!=null?n.protocol:void 0:void 0)==="https:"?"https":"http",""+t+"://"+e+"/flashsocket"},t}(),s.XHRPolling=function(){function s(){this._send=e(this._send,this),this._poll=e(this._poll,this),s.__super__.constructor.apply(this,arguments)}var i;return r(s,t.Events),i=function(e,t,n,r){var i,s,o;s=function(e,t){try{return e.responseText?typeof t=="function"?t(null,JSON.parse(e.responseText)):void 0:typeof t=="function"?t(null,{}):void 0}catch(n){return typeof t=="function"?t({type:"cancel",reason:"protocol-error"},void 0):void 0}},i=function(e,t){var n;try{n=JSON.parse(e.responseText).error}catch(r){n=null}return typeof t=="function"?t(n||{type:"cancel",reason:"protocol-error"},void 0):void 0},o=new XMLHttpRequest;if("withCredentials"in o)o.onreadystatechange=function(){if(o.readyState===4)return o.status>=200&&o.status<300?s(o,r):i(o,r)},o.open(e,t,!0),o.setRequestHeader("Accept","application/json"),n!=null?(o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),o.send(JSON.stringify(n))):o.send(null);else{if(typeof XDomainRequest=="undefined")throw"CORS not supported";o=new XDomainRequest,o.onload=function(){return s(o,r)},o.onerror=function(){return i(o,r)},o.ontimeout=function(){return typeof r=="function"?r({type:"wait",reason:"remote-server-timeout"},void 0):void 0},o.open(e,t),n!=null?o.send(JSON.stringify(n)):o.send()}return o},s.prototype.initialize=function(e,t){return this.host=e,this.params=t,this._session=void 0,this._state="closed",this._sendBuffer=[],this._sendTimeout=void 0,this.on("open",this._poll)},s.prototype.open=function(){var e=this;return this._state="opening",this._request=i("POST",this._url(this.host),this.params,function(t,n){if(e._state!=="opening")return;return t!=null?(e._trigger("error",t),e._state="closed",e._trigger("close")):(e._session=n.session,e._state="open",e._trigger("open"))})},s.prototype.send=function(e){if(this._state==="open"){this._sendBuffer.push(n.extend({},e));if(this._sendTimeout==null)return this._sendTimeout=setTimeout(this._send,0)}},s.prototype.close=function(){var e,t,n=this;if((e=this._state)==="opening"||e==="open"){this._state="closing",(t=this._request)!=null&&t.abort(),this._request=null;try{return i("DELETE",this._url(this.host,this._session),null,function(){if(n._state==="closing")return n._state="closed",n._trigger("close")})}catch(r){return this._state="closed",this._trigger("close")}}},s.prototype.ping=function(){},s.prototype._poll=function(){var e=this;return this._request=i("GET",this._url(this.host,this._session),null,function(t,n){var r,i,s,o;if(e._state!=="open")return;if(t!=null)return e._trigger("error",t),e._state="closed",e._trigger("close");o=n.stanzas;for(i=0,s=o.length;i<s;i++)r=o[i],e._trigger("stanza",r);return e._poll()})},s.prototype._send=function(){var e,t=this;if(this._state==="open")return e={stanzas:this._sendBuffer},this._sendBuffer=[],this._sendTimeout=void 0,i("POST",this._url(this.host,this._session),e,function(e,n){var r;if(t._state!=="open")return;if(e!=null)return t._trigger("error",e),t._state="closed",(r=t._request)!=null&&r.abort(),t._request=null,t._trigger("close")})},s.prototype._url=function(e,t){return t!=null?"http://"+e+"/xhr-polling/"+t._id+":"+t.key+"?_="+(new Date).getTime():"http://"+e+"/xhr-polling?_="+(new Date).getTime()},s}(),a.Socket=function(){function i(){this._checkSystem=e(this._checkSystem,this),this._onClose=e(this._onClose,this),this._onError=e(this._onError,this),this._onStanza=e(this._onStanza,this),this._onOpen=e(this._onOpen,this),this._setupTransport=e(this._setupTransport,this),i.__super__.constructor.apply(this,arguments)}var n;return r(i,t.Events),n=5e3,i.prototype.initialize=function(e,t){return this.host=e,this.params=t!=null?t:{},this._state="opening",this._nextTransport=0,this._transport=void 0,this._transports=["WebSocket","FlashSocket","SecureWebSocket","XHRPolling"],this._lastCheck=null,this._checkTimeout=setInterval(this._checkSystem,n),typeof process!="undefined"?process.nextTick(this._setupTransport):setTimeout(this._setupTransport,0)},i.prototype.send=function(e){return this._transport.send(e)},i.prototype.close=function(){switch(this._state){case"opening":return this._teardownTransport(),this._onClose();case"open":return this._state="closing",this._transport.close()}},i.prototype._setupTransport=function(){var e;this._teardownTransport();if(!(e=this._transports[this._nextTransport++]))return this._trigger("error",{type:"cancel",reason:"transport-error"}),this._state="closed",this._trigger("close");try{return this._transport=new s[e](this.host,this.params),this._transport.on("open",this._onOpen),this._transport.on("stanza",this._onStanza),this._transport.on("error",this._onError),this._transport.on("close",this._onClose),this._transport.open()}catch(t){this._setupTransport()}},i.prototype._teardownTransport=function(){if(this._transport==null)return;return this._transport.off("open",this._onOpen),this._transport.off("stanza",this._onStanza),this._transport.off("error",this._onError),this._transport.off("close",this._onClose),this._transport.close(),this._transport=void 0},i.prototype._onOpen=function(){return this._state="open",this._trigger("open")},i.prototype._onStanza=function(e){return this._trigger("stanza",e)},i.prototype._onError=function(e){var t;return this._state!=="opening"||e.type!=="cancel"||(t=e.reason)!=="transport-error"&&t!=="protocol-error"?(this._state="closing",this._trigger("error",e)):this._setupTransport()},i.prototype._onClose=function(){return this._state==="opening"?this._setupTransport():(this._state="closed",this._trigger("close")),clearInterval(this._checkTimeout),this._checkTimeout=null},i.prototype._checkSystem=function(){var e;e=new Date;if(!(this._lastCheck!=null&&e.getTime()-this._lastCheck.getTime()>2*n))return this._lastCheck=e;this._lastCheck=e;if(this._state==="open")return this._transport.ping()},i}(),a})}.call(this),function(){var e=Object.prototype.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},r=function(e,t){return function(){return e.apply(t,arguments)}};n("lib/models",["./events","./deferred","./utils"],function(n,i,s){var o;return o={},o.Model=function(){function e(){e.__super__.constructor.apply(this,arguments)}return t(e,n.Events),e.prototype.initialize=function(e){return this._properties=s.extend({},e),this._refcount=1},e.prototype.dispose=function(){},e.prototype.get=function(e){return this._properties[e]},e.prototype._update=function(e){return s.update(this._properties,e),this._trigger("update",e)},e.prototype._sync=function(e){return this._properties=s.extend({},e),this._trigger("sync",e)},e}(),o.Collection=function(){function e(){e.__super__.constructor.apply(this,arguments)}return t(e,n.Events),e.prototype.initialize=function(){return this._items=null,this._pending=null,this._synched=!1},e.prototype.get=function(){var e;return this._items!=null?(e=new i.Deferred,e.resolve(this._items),e.promise()):this._pending!=null?this._pending:(this._pending=new i.Deferred,this._pending)},e.prototype._sync=function(e){this._items=e.items,this._synched=!0,this._trigger("sync",this._items);if(this._pending!=null)return this._pending.resolve(this._items),this._pending=null},e.prototype._add=function(e){var t,n,r,i,s,o;if(!this._synched)return;e.before!=null?n=this._indexOf(e.before):n=this._items.length,t=[],o=e.items;for(i=0,s=o.length;i<s;i++)r=o[i],this._indexOf(r._id)==null&&(this._items.splice(n,0,r),t.push(r));if(t.length>0)return this._trigger("add",t,e.before)},e.prototype._remove=function(e){var t,n,r,i,s,o;if(!this._synched)return;r=[],o=e.items;for(i=0,s=o.length;i<s;i++)n=o[i],(t=this._indexOf(n._id))!=null&&(this._items.splice(t,1),r.push(n));if(r.length>0)return this._trigger("remove",r,e.reason)},e.prototype._update=function(e){var t,n,r,i,o,u,a,f,l;if(!this._synched)return;r={},f=e.items;for(i=0,u=f.length;i<u;i++)t=f[i],r[t._id]=t;l=this._items;for(o=0,a=l.length;o<a;o++)t=l[o],(n=r[t._id])!=null&&s.update(t,n);return this._trigger("update",e.items)},e.prototype._move=function(e){var t,n,r,i,s;if(!this._synched)return;s=e.items;for(r=0,i=s.length;r<i;r++)n=s[r],t=this._items.splice(this._indexOf(n._id),1)[0],e.before!=null?this._items.splice(this._indexOf(e.before),0,t):this._items.push(t);return this._trigger("move",e.items,e.before)},e.prototype._onNotification=function(e,t,n){if(e==null)switch(t){case"+sync":return this._sync(n);case"+add":return this._add(n);case"+remove":return this._remove(n);case"+update":return this._update(n);case"+move":return this._move(n)}},e.prototype._indexOf=function(e){var t,n,r,i;i=this._items;for(t=0,r=i.length;t<r;t++){n=i[t];if(n._id===e)return t}return null},e}(),o.EntityCollection=function(){function e(){this._onDisconnect=r(this._onDisconnect,this),this._gc=r(this._gc,this),e.__super__.constructor.apply(this,arguments)}return t(e,o.Collection),e.prototype.initialize=function(t,n,r){this.client=t,this.url=n,r==null&&(r=!1),e.__super__.initialize.apply(this,arguments),this._items=null,this._pending=null,this._refcount=0,this._gcTimeout=null,this.client.on("disconnect",this._onDisconnect);if(r)return this.add=function(e,t){var n=this;return t==null&&(t=void 0),this.client.request(this.url,".add",{items:e,before:t}).pipe(function(e){return n._add(e),e})},this.remove=function(e,t){var n=this;return t==null&&(t=void 0),this.client.request(this.url,".remove",{items:e,reason:t}).pipe(function(e){return n._remove(e),e})}},e.prototype.dispose=function(){return this.client.off("disconnect",this._onDisconnect)},e.prototype.get=function(){var e,t,n,r=this;return this._items!=null?(this._refcount++,n=new i.Deferred,n.resolve(this._items),n.promise()):this._pending!=null?(this._pending._soundrop_refcount++,this._pending):(t=this.client.request(this.url,".get",{}),e=t.pipe(function(e){return r._refcount=r._pending._soundrop_refcount,delete r._pending,r._sync(e),r._gcTimeout==null&&(r._gcTimeout=setInterval(r._gc,6e4)),r._items},function(e){return delete r._pending,e}),this._pending=e,e._soundrop_refcount=1,e)},e.prototype.unget=function(){if(this._items!=null)return this._refcount--;if(this._pending!=null)return this._pending._soundrop_refcount--},e.prototype._gc=function(){if(this._refcount<=0)return this._items=null,clearInterval(this._gcTimeout),this._gcTimeout=null,this.client.request(this.url,".unget",{})},e.prototype._onDisconnect=function(){return this._items=null,delete this._pending,clearInterval(this._gcTimeout)},e}(),o.Entity=function(){function e(){this._onDisconnect=r(this._onDisconnect,this),this._gc=r(this._gc,this),e.__super__.constructor.apply(this,arguments)}return t(e,n.Events),e.prototype.initialize=function(e,t){return this.client=e,this.url=t,this._entity=null,this._pending=null,this._refcount=0,this.client.on("disconnect",this._onDisconnect),this._gcTimeout=null},e.prototype.dispose=function(){return this.client.off("disconnect",this._onDisconnect)},e.prototype.get=function(){var e,t,n,r=this;return this._entity!=null?(this._refcount++,n=new i.Deferred,n.resolve(this._entity),n.promise()):this._pending!=null?(this._pending._soundrop_refcount++,this._pending):(t=this.client.request(this.url,".get",{}),e=t.pipe(function(e){return r._refcount=r._pending._soundrop_refcount,delete r._pending,r._entity=e,r._gcTimeout==null&&(r._gcTimeout=setInterval(r._gc,6e4)),r._entity},function(e){return delete r._pending,e}),this._pending=e,e._soundrop_refcount=1,e)},e.prototype.unget=function(){if(this._entity!=null)return this._refcount--;if(this._pending!=null)return this._pending._soundrop_refcount--},e.prototype._sync=function(e){return this._entity=e,this._trigger("sync",e)},e.prototype._update=function(e){return s.update(this._entity,e),this._trigger("update",e)},e.prototype._delete=function(e){return delete this._entity,this._trigger("delete")},e.prototype._onNotification=function(e,t,n){if(e==null)switch(t){case"+sync":return this._sync(n);case"+update":return this._update(n);case"+delete":return this._delete(n)}},e.prototype._gc=function(){if(this._refcount<=0)return this._entity=null,clearInterval(this._gcTimeout),this._gcTimeout=null,this.client.request(this.url,".unget",{})},e.prototype._onDisconnect=function(){return this._entity=null,delete this._pending,clearInterval(this._gcTimeout)},e}(),o.Models=function(){function s(){this._onDisconnect=r(this._onDisconnect,this),this._gc=r(this._gc,this),s.__super__.constructor.apply(this,arguments)}return t(s,n.Events),s.prototype.initialize=function(e,t){return this.client=e,this.klass=t,this._pending={},this._models={},this.client.on("disconnect",this._onDisconnect),this._gcTimeout=null},s.prototype.dispose=function(){return this.client.off("disconnect",this._onDisconnect)},s.prototype.get=function(e){var t,n,r,s,o=this;return(t=this._models[e])?(t._refcount++,s=new i.Deferred,s.resolve(t),s.promise()):(n=this._pending[e])?(n._soundrop_refcount++,n):(r=this.client.request(this.klass.url(e),".get",{}),n=r.pipe(function(n){return t=new o.klass(o,n),t._refcount=o._pending[e]._soundrop_refcount,delete o._pending[e],o._models[e]=t,o._gcTimeout==null&&(o._gcTimeout=setInterval(o._gc,6e4)),t},function(t){return delete o._pending[e],t}),this._pending[e]=n,n._soundrop_refcount=1,n)},s.prototype._get=function(e){var t,n=this;return t=this.client._request(this.klass.url(e),".get",{}),t.pipe(function(t){var r;return r=new n.klass(n,t),r._refcount=1,n._models[e]=r,n._gcTimeout==null&&(n._gcTimeout=setInterval(n._gc,6e4)),r})},s.prototype.unget=function(e){var t,n;if(t=this._models[e])return t._refcount--;if(n=this._pending[e])return n._soundrop_refcount--},s.prototype._gc=function(){var t,n,r,i;r=this._models,i=[];for(t in r){if(!e.call(r,t))continue;n=r[t],n._refcount<=0?(this._models[t].dispose(),delete this._models[t],i.push(this.client.request(this.klass.url(t),".unget",{}))):i.push(void 0)}return i},s.prototype._onDisconnect=function(){var t,n,r;r=this._models;for(t in r){if(!e.call(r,t))continue;n=r[t],n.dispose()}return this._models={},this._pending={},clearInterval(this._gcTimeout)},s}(),o})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,r=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};n("lib/applications/membership",["../events","../models"],function(t,n){var i;return i={},i.Membership=function(){function i(){this._onMembersRemove=e(this._onMembersRemove,this),this._onMembersAdd=e(this._onMembersAdd,this),i.__super__.constructor.apply(this,arguments)}return r(i,t.Events),i.prototype.initialize=function(e,t){return this._id=e,this._space=t,Object.defineProperty(this,"presence",{get:function(){return t.getPresence(e)}}),Object.defineProperty(this,"parameters",{get:function(){return t.getParameters(e)}}),this.members_live_count=0,this.members_max_count=0,this.members_total_count=0,this.members=new n.Collection,this.members.on("add",this._onMembersAdd),this.members.on("remove",this._onMembersRemove)},i.prototype.dispose=function(){return this.members.off("add",this._onMembersAdd),this.members.off("remove",this._onMembersRemove),this._space=null},i.prototype._onNotification=function(e,t,n){var r;if(e==null)switch(t){case"+sync":return this.members._sync({items:n.members}),this.members_live_count=n.members_live_count,this.members_max_count=n.members_max_count,this.members_total_count=n.members_total_count,this._syncPresence(),this._trigger("sync")}else if((r=e.match(/^\/members(\/.+)?/))!=null)return this.members._onNotification(r[1],t,n)},i.prototype._onMembersAdd=function(e,t){return this.members_live_count+=e.length,this.members_max_count=Math.max(this.members_max_count,this.members_live_count),this.members_total_count+=e.length,this._trigger("update",{members_live_count:this.members_live_count,members_max_count:this.members_max_count,members_total_count:this.members_total_count}),this._syncPresence()},i.prototype._onMembersRemove=function(e,t){return this.members_live_count-=e.length,this._trigger("update",{members_live_count:this.members_live_count}),this._syncPresence()},i.prototype._syncPresence=function(){var e=this;return this.presence.members_live_count=this.members_live_count,this.presence.members_max_count=this.members_max_count,this.presence.members_total_count=this.members_total_count,this.members.get().done(function(t){var n,r,i,s;r=[];for(i=0,s=t.length;i<s;i++){n=t[i];if(n.user!=null){r.push(n);if(r.length===5)break}}return e.presence.members_summary=r,e._space._trigger("update",{_id:e._space.get("_id"),presence:{"soundrop:membership":e.presence}})})},i}(),i})}.call(this),function(){var e=Object.prototype.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},r=Array.prototype.indexOf||function(t){for(var n=0,r=this.length;n<r;n++)if(e.call(this,n)&&this[n]===t)return n;return-1};n("lib/applications/playlist",["../events","../models"],function(e,n){var i;return i={},i.Playlist=function(){function i(){i.__super__.constructor.apply(this,arguments)}return t(i,e.Events),i.prototype.initialize=function(e,t){return this._id=e,this._space=t,this._synched=!1,Object.defineProperty(this,"presence",{get:function(){return t.getPresence(e)}}),Object.defineProperty(this,"parameters",{get:function(){return t.getParameters(e)}}),this._url="/spaces/"+this._space.get("_id")+"/applications/"+this._id,this.playback=void 0,this.items=new n.Collection},i.prototype.dispose=function(){return this._space=null,this._synched=!1},i.prototype.add=function(e){return this._space.client.notify(this._url+"/items","+add",{items:e})},i.prototype.remove=function(e){return this._space.client.notify(this._url+"/items","+remove",{items:e})},i.prototype.move=function(e,t){return this._space.client.notify(this._url+"/items","+move",{items:e,before:t})},i.prototype.vote=function(e){return this._space.client.notify(this._url,"+vote",{items:e})},i.prototype.report=function(e){return this._space.client.notify(this._url,"+report",{items:e})},i.prototype.play=function(e,t){return t==null&&(t=0),this._space.client.notify(this._url,"+play",{item:e,offset:t})},i.prototype.clear=function(){return this._space.client.notify(this._url,"+clear",{})},i.prototype.shuffle=function(){return this._space.client.notify(this._url,"+shuffle",{})},i.prototype.favorited=function(e){return this._space.client.notify(this._url,"+favorited",{items:e})},i.prototype.played=function(e){return this._space.client.notify(this._url,"+played",{items:e})},i.prototype._onNotification=function(e,t,n){var i,s,o,u,a=this;if(e==null){u=function(e){var t;return t=new Date,t.setMilliseconds(t.getMilliseconds()-e),t};switch(t){case"+sync":return this._synched=!0,this.playback=n.playback?{item:n.playback.item,started:u(n.playback.offset)}:void 0,this.items._sync({items:n.items}),this._trigger("sync");case"+play":if(!this._synched)return;return this.playback==null&&(this.playback={}),this.playback.item=n.item,this.playback.started=u(n.offset),this._trigger("play",n.item,n.offset);case"+stop":if(!this._synched)return;return this.playback=void 0,this._trigger("stop");case"+vote":if(!this._synched)return;return i=function(){var e,t,r,i;r=n.items,i=[];for(e=0,t=r.length;e<t;e++)s=r[e],i.push(s._id);return i}(),this.items.get().done(function(e){var t,s,o,u;for(s=0,o=e.length;s<o;s++)t=e[s],(u=t._id,r.call(i,u)>=0)&&t.votes.unshift(n.user);return a._trigger("vote",n.items,n.user)});case"+favorited":if(!this._synched)return;return this._trigger("favorited",n.items,n.user)}}else if((o=e.match(/^\/items(\/.+)?/))!=null)return this.items._onNotification(o[1],t,n)},i}(),i})}.call(this),function(){var e=Object.prototype.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};n("lib/applications/chat",["../events","../models"],function(e,n){var r;return r={},r.Chat=function(){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,e.Events),r.prototype.initialize=function(e,t){return this._id=e,this._space=t,this._url="/spaces/"+this._space.get("_id")+"/applications/"+this._id,Object.defineProperty(this,"presence",{get:function(){return t.getPresence(e)}}),Object.defineProperty(this,"parameters",{get:function(){return t.getParameters(e)}}),this.messages=new n.Collection},r.prototype.dispose=function(){return this._space=null},r.prototype.add=function(e,t){return t==null&&(t="normal"),this._space.client.notify(this._url+"/messages","+add",{items:[{message:e,type:t}]})},r.prototype.remove=function(e){return this._space.client.notify(this._url+"/messages","+remove",{items:e})},r.prototype._onNotification=function(e,t,n){var r;if(e==null)switch(t){case"+sync":return this.messages._sync({items:n.messages}),this._trigger("sync")}else if((r=e.match(/^\/messages(\/.+)?/))!=null)return this.messages._onNotification(r[1],t,n)},r}(),r})}.call(this),n("lib/applications",["./applications/membership","./applications/playlist","./applications/chat"],function(e,t,n){return{"soundrop:membership":e.Membership,"soundrop:playlist":t.Playlist,"soundrop:chat":n.Chat}}),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,r=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},i=Array.prototype.indexOf||function(e){for(var n=0,r=this.length;n<r;n++)if(t.call(this,n)&&this[n]===e)return n;return-1};n("lib/spaces",["./events","./models","./applications","./deferred"],function(n,s,o,u){var a,f;return f={},a=function(){function n(){this._onLeave=e(this._onLeave,this),n.__super__.constructor.apply(this,arguments)}return r(n,s.Model),n.url=function(e){return"/spaces/"+e},n.prototype.initialize=function(e,t){return this.spaces=e,n.__super__.initialize.call(this,t),this.client=this.spaces.client,this.state="not-joined",this._request=null,this.applications={},this.insights=new s.Entity(this.client,"/spaces/"+this.get("_id")+"/insights"),this.on("leave",this._onLeave)},n.prototype.dispose=function(){return n.__super__.dispose.apply(this,arguments),this.spaces=null,this.state="not-joined",this.insights.dispose(),this.off("leave",this._onLeave),this._unloadApplications()},n.prototype.getPresence=function(e){var t;return(t=this.get("presence"))!=null?t[e]:void 0},n.prototype.getParameters=function(e){var t;return(t=this.get("parameters"))!=null?t[e]:void 0},n.prototype.getApplication=function(e){return this.applications[e]},n.prototype.isAdmin=function(e){var t;return e!=null?e.get("status")==="admin"||(t=e.get("_id"),i.call(this.get("owners"),t)>=0):!1},n.prototype.join=function(){var e=this;switch(this.state){case"not-joined":return this.state="joining",this._loadApplications(),this._request=this.spaces.client.request("/spaces/"+this.get("_id"),".join",{}),this._request.pipe(function(t){return e.state==="joining"?(e._request=null,e.state="joined",e._trigger("join"),e.spaces._onJoin(e),t):(new u.Deferred).reject().promise()},function(t){return e.state==="joining"&&(e.state="not-joined",e._unloadApplications()),e._request=null,t});case"joining":return this._request;case"joined":return(new u.Deferred).resolve().promise()}},n.prototype.leave=function(){switch(this.state){case"not-joined":return(new u.Deferred).resolve().promise();case"joining":case"joined":return this.spaces.client.request("/spaces/"+this.get("_id"),".leave",{}),this.state="not-joined",this._trigger("leave"),this._request=null,(new u.Deferred).resolve().promise()}},n.prototype.update=function(e){var t,n=this;return t=this.spaces.client.request("/spaces/"+this.get("_id"),".update",e),t.pipe(function(e){return n._update(e),e})},n.prototype["delete"]=function(){var e,t=this;return e=this.spaces.client.request("/spaces/"+this.get("_id"),".delete",{}),e.pipe(function(e){return t._delete(),e})},n.prototype.addAccount=function(e){return this.spaces.client.request("/spaces/"+this.get("_id"),".add-account",e)},n.prototype._update=function(e){return e.parameters!==void 0&&this._updateApplications(e.parameters||{}),n.__super__._update.call(this,e)},n.prototype._delete=function(){var e,n,r,i;this._update({status:"deleted"}),this._trigger("delete"),r=this.applications,i=[];for(n in r){if(!t.call(r,n))continue;e=r[n],i.push(e.dispose())}return i},n.prototype._loadApplications=function(){var e,n,r,i,s;i=this.get("parameters")||{},s=[];for(e in i){if(!t.call(i,e))continue;r=i[e],(n=o[e])?s.push(this.applications[e]=new n(e,this)):s.push(void 0)}return s},n.prototype._updateApplications=function(e){var n,r,i,s,u,a,f,l,c,h,p,d;n=[];for(i in e){if(!t.call(e,i))continue;u=e[i],this.applications[i]==null&&n.push(i)}a=[],p=this.applications;for(i in p){if(!t.call(p,i))continue;r=p[i],e[i]==null&&a.push(i)}for(f=0,c=a.length;f<c;f++)i=a[f],r=this.applications[i],this._trigger("remove-application",i,r),delete this.applications[i],r.dispose();d=[];for(l=0,h=n.length;l<h;l++)i=n[l],(s=o[i])?(r=new s(i,this),this.applications[i]=r,d.push(this._trigger("add-application",i,r))):d.push(void 0);return d},n.prototype._unloadApplications=function(){var e,n,r;r=this.applications;for(n in r){if(!t.call(r,n))continue;e=r[n],e.dispose()}return this.applications={}},n.prototype._onNotification=function(e,t,n){var r,i;if(e==null)switch(t){case"+update":return this._update(n);case"+sync":return this._sync(n);case"+delete":return this._delete();case"+leave":return this.state="not-joined",this._trigger("leave")}else if((i=e.match(/^\/applications\/([^\/]+)(\/.+)?/))!=null){if((r=this.applications[i[1]])!=null)return r._onNotification(i[2],t,n)}else if((i=e.match(/^\/insights(\/.+)?/))!=null)return this.insights._onNotification(i[1],t,n)},n.prototype._onLeave=function(){var e,t;return t=this.getPresence("soundrop:membership"),t!=null&&(t.members_live_count--,t.members_summary!=null&&(t.members_summary=function(){var n,r,i,s;i=t.members_summary,s=[];for(n=0,r=i.length;n<r;n++)e=i[n],e._id!==this.client.user.get("_id")&&s.push(e);return s}.call(this)),this._trigger("update",{_id:this.get("_id"),presence:{"soundrop:membership":t}})),this.spaces._onLeave(this),this._unloadApplications()},n}(),f.Spaces=function(){function t(){this._onNotification=e(this._onNotification,this),t.__super__.constructor.apply(this,arguments)}return r(t,s.Models),t.prototype.initialize=function(e){return t.__super__.initialize.call(this,e,a),this.client.on("notification",this._onNotification),this.genres=new s.EntityCollection(e,"/spaces/genres"),this.trending=new s.EntityCollection(e,"/spaces/trending")},t.prototype.dispose=function(){return t.__super__.dispose.apply(this,arguments),this.client.off("notification",this._onNotification),this.trending.dispose()},t.prototype.search=function(e,t,n){return this.client.request("/spaces",".search",{query:e,page:t,limit:n})},t.prototype.getId=function(e){return this.client.request("/spaces",".get-id",e)},t.prototype.create=function(e){return this.client.request("/spaces",".create",e)},t.prototype._onJoin=function(e){return this._trigger("join",e)},t.prototype._onLeave=function(e){return this._trigger("leave",e)},t.prototype._onNotification=function(e,t,n){var r,i;if((r=e.match(/^\/spaces\/([^\/]+)(\/.+)?/))!=null)if(i=this._models[r[1]])return i._onNotification(r[2],t,n)},t}(),f})}.call(this),function(){var e=Object.prototype.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},r=Array.prototype.indexOf||function(t){for(var n=0,r=this.length;n<r;n++)if(e.call(this,n)&&this[n]===t)return n;return-1},i=function(e,t){return function(){return e.apply(t,arguments)}};n("lib/users",["./events","./models","./deferred"],function(n,s,o){var u;return u={},u.User=function(){function n(){n.__super__.constructor.apply(this,arguments)}return t(n,s.Model),n.url=function(e){return"/users/"+e},n.prototype.initialize=function(e,t){var r,i;return this.users=e,n.__super__.initialize.call(this,t),r=this.users.client,i=this.get("_id"),this.spaces={owned:new s.EntityCollection(r,"/users/"+i+"/spaces/owned"),favorites:new s.EntityCollection(r,"/users/"+i+"/spaces/favorites",!0),recommendations:new s.EntityCollection(r,"/users/"+i+"/spaces/recommendations"),recent:new s.EntityCollection(r,"/users/"+i+"/spaces/recent",!0)},this.users={friends:new s.EntityCollection(r,"/users/"+i+"/users/friends")}},n.prototype.dispose=function(){var t,r,i,s,o;n.__super__.dispose.apply(this,arguments),i=this.spaces;for(r in i){if(!e.call(i,r))continue;t=i[r],t.dispose()}s=this.users,o=[];for(r in s){if(!e.call(s,r))continue;t=s[r],o.push(t.dispose())}return o},n.prototype.isAdmin=function(e){var t;return this.get("status")==="admin"||e!=null&&(t=this.get("_id"),r.call(e.get("owners"),t)>=0)},n.prototype._onSpaceDelete=function(t){var n,r,i,s;i=this.spaces,s=[];for(n in i){if(!e.call(i,n))continue;r=i[n],s.push(r._remove({items:[{_id:t}]}))}return s},n.prototype._onNotification=function(e,t,n){var r,i;if(e==null)switch(t){case"+update":return this._update(n);case"+sync":return this._sync(n)}else if((i=e.match(/^\/(spaces|users)\/([^\/]+)(\/.+)?/))!=null)if(r=this[i[1]][i[2]])return r._onNotification(i[3],t,n)},n}(),u.AnonymousUser=function(){function u(){u.__super__.constructor.apply(this,arguments)}var e,r;return t(u,s.Model),u.url=function(e){return"/users/"+e},u.prototype.initialize=function(t){var n;return u.__super__.initialize.call(this,void 0),n=new r,this.spaces={owned:n,favorites:n,recommendations:new s.EntityCollection(t,"/users/undefined/spaces/recommendations"),recent:new e(t)},this.users={friends:n}},u.prototype.dispose=function(){return u.__super__.dispose.apply(this,arguments),this.spaces.recent.dispose()},u.prototype.isAdmin=function(e){return!1},r=function(){function e(){e.__super__.constructor.apply(this,arguments)}return t(e,n.Events),e.prototype.initialize=function(){},e.prototype.get=function(){var e;return e={type:"cancel",reason:"not-allowed",message:"request not allowed"},(new o.Deferred).reject(e).promise()},e.prototype.unget=function(){},e}(),e=function(){function e(){this._onStanzaOut=i(this._onStanzaOut,this),e.__super__.constructor.apply(this,arguments)}return t(e,n.Events),e.prototype.initialize=function(e){return this.client=e,this._spaces=[],this.client.on("stanza-out",this._onStanzaOut)},e.prototype.dispose=function(){return this.client.off("stanza-out",this._onStanzaOut)},e.prototype.get=function(){return(new o.Deferred).resolve(this._spaces).promise()},e.prototype.unget=function(){},e.prototype.add=function(){var e;return e={type:"cancel",reason:"not-allowed",message:"request not allowed"},(new o.Deferred).reject(e).promise()},e.prototype.remove=function(){var e;return e={type:"cancel",reason:"not-allowed",message:"request not allowed"},(new o.Deferred).reject(e).promise()},e.prototype._onStanzaOut=function(e){var t,n,r,i,s,o,u=this;if(e.name===".join"&&(t=e.to.match(/^\/spaces\/([^\/]+)$/))){r={_id:t[1],date_joined:(new Date).toISOString()},o=this._spaces;for(i=0,s=o.length;i<s;i++){n=o[i];if(n._id===r._id){n.date_joined=r.date_joined,this._trigger("update",[r]);return}}return this.client.spaces.get(r._id).done(function(e){return n={_id:e.get("_id"),display_name:e.get("display_name"),parameters:e.get("parameters"),date_joined:r.date_joined},u._spaces.unshift(n),u._trigger("add",[n],null),u.client.spaces.unget(r._id)})}},e}(),u}.call(this),u.Users=function(){function n(){this._onNotification=i(this._onNotification,this),n.__super__.constructor.apply(this,arguments)}return t(n,s.Models),n.prototype.initialize=function(e){return n.__super__.initialize.call(this,e,u.User),this.client.on("notification",this._onNotification)},n.prototype.dispose=function(){return n.__super__.dispose.apply(this,arguments),this.client.off("notification",this._onNotification)},n.prototype._onNotification=function(t,n,r){var i,s,o,u,a;if((s=t.match(/^\/users\/([^\/]+)(\/.+)?/))!=null){if(o=this._models[s[1]])return o._onNotification(s[2],n,r)}else if(n==="+delete"&&(s=t.match(/^\/spaces\/([^\/]+)/))!=null){u=this._models,a=[];for(i in u){if(!e.call(u,i))continue;o=u[i],a.push(o._onSpaceDelete(s[1]))}return a}},n}(),u})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,r=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};n("lib/client",["./events","./deferred","./wocket","./spaces","./users","./utils"],function(t,n,i,s,o,u){var a,f,l;return a={},l=0,f=function(){return(l++).toString(16)},a.Client=function(){function a(){this._onClose=e(this._onClose,this),this._onError=e(this._onError,this),this._onStanza=e(this._onStanza,this),this._onConnected=e(this._onConnected,this),this._onOpen=e(this._onOpen,this),a.__super__.constructor.apply(this,arguments)}return r(a,t.Events),a.prototype.initialize=function(e){return this.options=e!=null?e:{},this.state="disconnected",this.user=null,this.users=new o.Users(this),this.spaces=new s.Spaces(this),this._socket=null,this._requests={}},a.prototype.connect=function(){if(this.state==="disconnected")return this.state="connecting",this._requests={},this._socket=new i.Socket("wocket."+this.options.host,{client:u.extend({},this.options.client,{protocol:2}),user:this.options.user}),this._socket.on("open",this._onOpen),this._socket.on("stanza",this._onStanza),this._socket.on("error",this._onError),this._socket.on("close",this._onClose);throw"unexpected-state"},a.prototype.disconnect=function(){return this.state="disconnecting",this._socket.close()},a.prototype.isAuthenticated=function(){var e;return((e=this.user)!=null?e.get("_id"):void 0)!=null},a.prototype.request=function(e,t,r){return this.state!=="connected"?(new n.Deferred).reject().promise():this._request(e,t,r)},a.prototype._request=function(e,t,r){var i,s,o;return s=new n.Deferred,i=f(),this._requests[i]=s,o={_id:i,to:e,name:t,payload:r},this._socket.send(o),this._trigger("stanza-out",o),s.promise()},a.prototype.notify=function(e,t,n){var r;if(this.state!=="connected")return;return r={_id:f(),to:e,name:t,payload:n},this._socket.send(r),this._trigger("stanza-out",r)},a.prototype._onOpen=function(){var e=this;return this._request(void 0,".get",{}).done(function(t){var n,r;return(n=(r=t.user)!=null?r._id:void 0)!=null?e.users._get(n).done(e._onConnected):e._onConnected(new o.AnonymousUser(e))})},a.prototype._onConnected=function(e){return this.state="connected",this.user=e,this._trigger("connect")},a.prototype._onStanza=function(e){var t,n;this._trigger("stanza-in",e);if(!(t=e._id))return this._trigger("notification",e.from,e.name,e.payload);if((n=this._requests[t])!=null)return e.name==="+error"?n.reject(e.payload):e.name==="+result"&&n.resolve(e.payload),delete this._requests[t]},a.prototype._onError=function(e){return this._trigger("error",e)},a.prototype._onClose=function(){return this._socket!=null&&(this._requests={},this._socket.off("open",this._onOpen),this._socket.off("stanza",this._onStanza),this._socket.off("error",this._onError),this._socket.off("close",this._onClose),this._socket=null),this.state="disconnected",this.user!=null&&(this.user.get("_id")==null&&this.user.dispose(),this.user=null),this._trigger("disconnect")},a}(),a})}.call(this),n("main",["./lib/client","./lib/deferred","./lib/utils"],function(e,t,n){return{Client:e.Client,deferred:t,utils:n}}),n("main.standalone",["./main"],function(e){return typeof module!="undefined"&&module.exports?module.exports=e:window.soundrop=e,e}),t(["main.standalone"],function(){},"main.init",!0)})();